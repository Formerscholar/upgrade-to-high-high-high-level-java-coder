## 有索引数据如何查询



#### 1、非聚簇索引以组合索引为例

![avatar](../../images/dd9854379d75.png)

查找数据过程，根节点常驻内存，根据查询条件的第一个条件，从根节点开始查找，本次查找直至查找到对应的叶子节点（数据页），然后根据第二个条件做二分法查找，再根据后续的条件做二分法查找。

例子：

第一个条件 = 13，第二个条件 = 16， 第三个条件 = 5，查询过程，是根据 = 13的条件从根节点判断，根节点中第一个索引的起始为1,1 < 13，根节点中第二个索引的起始为56, 56 >13，那么证明需要的数据在第一个索引和第二个索引之间，随即从硬盘读取需要的索引节点数据，然后使用二分法查找到新的索引节点的第二个索引的起始为12,12 < 13，新的索引节点的第二个索引的起始为21,21 > 13，那么证明需要的数据在第二个索引与第三个索引之间，随即从硬盘读取到需要的索引节点数据，这次读取到的是叶子节点，然后找到了 = 13的数据，然后使用第二个条件的=16去叶子节点查找数据，使用二分法，找到 = 16的数据有2条，然后再用第三个条件的 =3去叶子节点继续查找数据，然后就找到了需要的数据的id，然后就拿着id = 3这个条件去<font color="red">回表</font>（到主键索引中）查询需要的数据（字段）。回表查询我们后面再说！



使用注意：

1. 极左原则：

   上述sql语句设置的组合索引为：index(a,b,c)，那么查询sql一定要写成如下才会精确使用组合索引：

   select .... from user where a = 10 and b = 1 and c = 2 条件a、b、c顺序可以任意互换，因为sql优化器会进行优化

   select .... from user where a = 10 and b = 1 条件a、b顺序可以任意互换，因为sql优化器会进行优化

   select .... from user where a = 10 

   

   而 sql语句如果写成这样，select .... from user where b = 1 或者 select .... from user where c = 2 或者 select .... from user where b = 1 and c=2 会不会走组合索引呢？答案是不会！因为index(a,b,c)这个组合索引是根据a进行排序分裂生成的B+Tree，然后在a相同的情况下，再根据b进行排序，在b相同的情况下，再根据c排序。在查找的时候呢，准入条件必须带a才能从B+Tree上搜索数据，而现在的查询条件上没有带的是a，自然B+Tree的准入条件都达不到，所以不会走索引！

   

   附上，组合索引B+Tree的叶子节点的数据模型如下图：

   ![avatar](file:///Users/tangwei/Desktop/%E8%AF%BE%E4%BB%B6/2%E3%80%81mysql/images/WechatIMG447.jpeg?lastModify=1675484988)

   

2. 遇到搜索条件为 like、in、between、>、< 等情况后，后面的条件不走索引：

   ![avatar](file:///Users/tangwei/Desktop/%E8%AF%BE%E4%BB%B6/2%E3%80%81mysql/images/WechatIMG447.jpeg?lastModify=1675484988)

   还是这张图，以a字段建立的B+Tree索引，是整体有序的。而b字段呢，是在a自动相同下保持相对有序，c字段是在b字段相同下保持相对有序。

   在使用条件 a=12 and b=8 and c=6的时候，是先通过a字段获取到数据，然后使用b字段通过二分法（左小右大）找到数据，再使用c字段通过二分法（左小右大）找到数据。

   在使用条件 a=12 and b < 8 and c=6的时候，是先通过a字段获取到数据，然后使用b字段通过二分法（左小右大）找到数据，再使用c字段通过二分法查找数据时发现c字段此时是无序的，根本没法使用二分法，所以c字段无法使用索引进行查找。

   如果把条件改为a=12 and c=6 and b < 8 跟上面的结果是一样的，因为sql优化器会对sql进行优化。优化成索引的字段的顺序。

#### 2、非聚簇索引以普通索引为例

![avatar](../../images/v2-525127069.webp)

查找数据过程，根节点常驻内存，根据条件从根节点开始查找，本次查找直至查找到对应的叶子节点（数据页）。



例子：

条件是查找到 = 004的数据，查询过程，根据 = 004的条件从根节点判断，根节点的第一个索引的起始为003,003 < 004，根节点的第二个索引的起始为005,005 > 004，那么证明需要的数据在第一个索引和第二个索引之间，随即从硬盘读取需要的索引节点数据，然后就找到了004的索引节点，然后就可以找到004的叶子节点。如果叶子节点中存储着其它字段的信息，就可以直接返回给用户，如果不存在其它字段的信息，就需要拿着id这个条件去<font color="red">回表</font>（到主键索引中）查询需要的数据（字段）。回表查询，我们后面再说！

